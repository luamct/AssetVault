name: macOS App

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS .app
    runs-on: macos-14
    env:
      MACOS_CERT_P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
      MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
      MACOS_CODESIGN_IDENTITY: ${{ secrets.MACOS_CODESIGN_IDENTITY }}
      APPLE_NOTARYTOOL_ISSUER_ID: ${{ secrets.APPLE_NOTARYTOOL_ISSUER_ID }}
      APPLE_NOTARYTOOL_KEY_ID: ${{ secrets.APPLE_NOTARYTOOL_KEY_ID }}
      APPLE_NOTARYTOOL_KEY_P8_BASE64: ${{ secrets.APPLE_NOTARYTOOL_KEY_P8_BASE64 }}

    steps:
      - name: Set env paths
        run: |
          echo "VCPKG_ROOT=${RUNNER_TEMP}/vcpkg" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_TRIPLET=arm64-osx" >> "$GITHUB_ENV"
          echo "ARTIFACT_DIR=${RUNNER_TEMP}/install" >> "$GITHUB_ENV"
          echo "SIGNING_KEYCHAIN_PATH=${RUNNER_TEMP}/signing.keychain-db" >> "$GITHUB_ENV"

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed
            ${{ env.VCPKG_ROOT }}/buildtrees
            ${{ env.VCPKG_ROOT }}/packages
            ${{ env.VCPKG_ROOT }}/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install vcpkg
        run: |
          if [ ! -d "${VCPKG_ROOT}/.git" ]; then
            rm -rf "${VCPKG_ROOT}"
            git clone https://github.com/microsoft/vcpkg "${VCPKG_ROOT}"
          fi
          git -C "${VCPKG_ROOT}" fetch --tags
          git -C "${VCPKG_ROOT}" checkout 8cce1e1118ea2569d5117f096035671a8490b8f4
          "${VCPKG_ROOT}/bootstrap-vcpkg.sh" -disableMetrics

      - name: Configure CMake (macOS preset)
        run: cmake --preset macos

      - name: Build
        run: cmake --build --preset macos

      - name: Install bundle
        run: cmake --install build --prefix "${ARTIFACT_DIR}"

      - name: Import Apple signing certificate (optional)
        if: ${{ env.MACOS_CERT_P12_BASE64 != '' && env.MACOS_CERT_PASSWORD != '' }}
        run: |
          CERT_PATH="${RUNNER_TEMP}/cert.p12"
          KEYCHAIN_PASSWORD="$(uuidgen)"
          echo "SIGNING_KEYCHAIN_PASSWORD=${KEYCHAIN_PASSWORD}" >> "$GITHUB_ENV"

          echo "${MACOS_CERT_P12_BASE64}" | base64 --decode > "${CERT_PATH}"
          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${SIGNING_KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${SIGNING_KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${SIGNING_KEYCHAIN_PATH}"
          security import "${CERT_PATH}" -P "${MACOS_CERT_PASSWORD}" -A -t cert -f pkcs12 -k "${SIGNING_KEYCHAIN_PATH}"
          security list-keychain -d user -s "${SIGNING_KEYCHAIN_PATH}"
          security set-key-partition-list -S apple-tool:,apple: -s -k "${KEYCHAIN_PASSWORD}" "${SIGNING_KEYCHAIN_PATH}"

      - name: Codesign app bundle (optional)
        if: ${{ env.MACOS_CODESIGN_IDENTITY != '' && env.MACOS_CERT_P12_BASE64 != '' && env.MACOS_CERT_PASSWORD != '' }}
        run: |
          APP_PATH="${ARTIFACT_DIR}/AssetVault.app"
          codesign --force --deep --options runtime --timestamp --sign "${MACOS_CODESIGN_IDENTITY}" "${APP_PATH}"
          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

      - name: Create zip for notarization
        run: |
          cd "${ARTIFACT_DIR}"
          ditto -c -k --sequesterRsrc --keepParent AssetVault.app "${RUNNER_TEMP}/AssetVault-notary.zip"

      - name: Notarize and staple (optional)
        if: ${{ env.MACOS_CODESIGN_IDENTITY != '' && env.APPLE_NOTARYTOOL_ISSUER_ID != '' && env.APPLE_NOTARYTOOL_KEY_ID != '' && env.APPLE_NOTARYTOOL_KEY_P8_BASE64 != '' }}
        run: |
          KEY_PATH="${RUNNER_TEMP}/AuthKey.p8"
          echo "${APPLE_NOTARYTOOL_KEY_P8_BASE64}" | base64 --decode > "${KEY_PATH}"

          xcrun notarytool submit "${RUNNER_TEMP}/AssetVault-notary.zip" \
            --key "${KEY_PATH}" \
            --key-id "${APPLE_NOTARYTOOL_KEY_ID}" \
            --issuer "${APPLE_NOTARYTOOL_ISSUER_ID}" \
            --wait

          xcrun stapler staple "${ARTIFACT_DIR}/AssetVault.app"

      - name: Package .app for download
        run: |
          cd "${ARTIFACT_DIR}"
          ditto -c -k --sequesterRsrc --keepParent AssetVault.app AssetVault-macos.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AssetVault-macos-app
          path: ${{ env.ARTIFACT_DIR }}/AssetVault-macos.zip
          retention-days: 7

      - name: Attach asset to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ARTIFACT_DIR }}/AssetVault-macos.zip
          fail_on_unmatched_files: true
