name: Windows App

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-2022

    steps:
      - name: Set env paths
        shell: pwsh
        run: |
          "VCPKG_ROOT=$env:RUNNER_TEMP\\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VCPKG_DEFAULT_TRIPLET=x64-windows-static" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ARTIFACT_DIR=$env:RUNNER_TEMP\\install" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}\installed
            ${{ env.VCPKG_ROOT }}\buildtrees
            ${{ env.VCPKG_ROOT }}\packages
            ${{ env.VCPKG_ROOT }}\downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install vcpkg
        shell: pwsh
        run: |
          if (!(Test-Path "$env:VCPKG_ROOT\\.git")) {
            Remove-Item -Recurse -Force "$env:VCPKG_ROOT" -ErrorAction SilentlyContinue
            git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
          }
          git -C "$env:VCPKG_ROOT" fetch --tags
          git -C "$env:VCPKG_ROOT" checkout 8cce1e1118ea2569d5117f096035671a8490b8f4
          & "$env:VCPKG_ROOT\\bootstrap-vcpkg.bat" -disableMetrics

      - name: Configure CMake (windows-static preset)
        shell: pwsh
        run: cmake --preset windows-static

      - name: Build (Release, static)
        shell: pwsh
        run: cmake --build --preset windows-static --config Release

      - name: Stage executable and runtime DLLs
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build\\windows-static"
          $exeDir = Join-Path $buildDir "Release"
          $exePath = Join-Path $exeDir "AssetVault.exe"
          if (!(Test-Path $exePath)) {
            throw "Expected executable not found: $exePath"
          }

          $stageDir = Join-Path $env:RUNNER_TEMP "AssetVault-windows"
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null
          Copy-Item $exePath -Destination $stageDir -Force

          $pdbPath = Join-Path $exeDir "AssetVault.pdb"
          if (Test-Path $pdbPath) {
            Copy-Item $pdbPath -Destination $stageDir -Force
          }

          Write-Host "Staged files:"
          Get-ChildItem -Path $stageDir | Format-Table Name, Length

      - name: Zip Windows bundle
        if: success()
        shell: pwsh
        run: |
          $stageDir = Join-Path $env:RUNNER_TEMP "AssetVault-windows"
          $zipPath = Join-Path $env:RUNNER_TEMP "AssetVault-windows.zip"
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path "$stageDir\*" -DestinationPath $zipPath
          Write-Host "Created release zip at $zipPath"
          $zipPosix = $zipPath -replace '\\','/'
          "WINDOWS_ZIP_PATH=$zipPosix" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AssetVault-windows
          path: ${{ runner.temp }}\\AssetVault-windows
          if-no-files-found: error
          retention-days: 7

      - name: Attach asset to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.WINDOWS_ZIP_PATH }}
          fail_on_unmatched_files: true
