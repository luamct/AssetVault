name: Windows App

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-2022

    steps:
      - name: Set env paths
        shell: pwsh
        run: |
          "VCPKG_ROOT=$env:RUNNER_TEMP\\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VCPKG_DEFAULT_TRIPLET=x64-windows" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ARTIFACT_DIR=$env:RUNNER_TEMP\\install" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}\installed
            ${{ env.VCPKG_ROOT }}\buildtrees
            ${{ env.VCPKG_ROOT }}\packages
            ${{ env.VCPKG_ROOT }}\downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install vcpkg
        shell: pwsh
        run: |
          if (!(Test-Path "$env:VCPKG_ROOT\\.git")) {
            Remove-Item -Recurse -Force "$env:VCPKG_ROOT" -ErrorAction SilentlyContinue
            git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
          }
          git -C "$env:VCPKG_ROOT" fetch --tags
          git -C "$env:VCPKG_ROOT" checkout 8cce1e1118ea2569d5117f096035671a8490b8f4
          & "$env:VCPKG_ROOT\\bootstrap-vcpkg.bat" -disableMetrics

      - name: Configure CMake (windows preset)
        shell: pwsh
        run: cmake --preset windows

      - name: Build (Release)
        shell: pwsh
        run: cmake --build --preset windows --config Release

      - name: Stage executable and runtime DLLs
        shell: pwsh
        run: |
          $exeDir = Join-Path $env:GITHUB_WORKSPACE "build\\Release"
          $exePath = Join-Path $exeDir "AssetVault.exe"
          if (!(Test-Path $exePath)) {
            throw "Expected executable not found: $exePath"
          }

          $stageDir = Join-Path $env:RUNNER_TEMP "AssetVault-windows"
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null
          Copy-Item $exePath -Destination $stageDir -Force

          $pdbPath = Join-Path $exeDir "AssetVault.pdb"
          if (Test-Path $pdbPath) {
            Copy-Item $pdbPath -Destination $stageDir -Force
          }

          $installedDir = Join-Path $env:GITHUB_WORKSPACE "build\\vcpkg_installed\\x64-windows"
          $applocal = Join-Path $env:VCPKG_ROOT "scripts\\buildsystems\\msbuild\\applocal.ps1"
          if (Test-Path $applocal) {
            & $applocal -targetBinary (Join-Path $stageDir "AssetVault.exe") -installedDir $installedDir
          }

          $zipPath = Join-Path $env:RUNNER_TEMP "AssetVault-windows.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $stageDir "*") -DestinationPath $zipPath

          Copy-Item $zipPath -Destination (Join-Path $env:GITHUB_WORKSPACE "AssetVault-windows.zip") -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AssetVault-windows
          path: AssetVault-windows.zip
          retention-days: 7
